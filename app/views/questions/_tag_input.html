<head>
<script src="https://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/flick/jquery-ui.css">
<%= stylesheet_link_tag "jquery-ui-slider-pips" %>
<%= javascript_include_tag "jquery-ui-slider-pips" %>

</head>

<% if @question == nil %>
<% @question = Question.where(slug: params[:id])[0] %>
<% end %>

<%@tag_array = Tag.where(question_id: @question.id).order(created_at: :asc)%>


<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true&libraries=visualization"></script>
<%= javascript_include_tag "markerwithlabel" %>

<script type="text/javascript">

  function initialize(check) {
    var user_lat = <%= Location.where(user_id: user_signed_in? ? current_user.id : cookies[:guest]).first.latitude %>
    var user_long = <%= Location.where(user_id: user_signed_in? ? current_user.id : cookies[:guest]).first.longitude %>

    <%if(Opinion.where(question_id: question.id, user_id: user_signed_in? ? current_user.id : cookies[:guest]).first.nil?)%>

      <%  opinion = Opinion.new
          loc_arr = opinion.user_lat_long_all(question.id)
      %>

      var mapOptions = {
        zoom: 4,
        center: new google.maps.LatLng(user_lat, user_long)
      };

      var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

      <% loc_arr.each do |location| %>
        var marker = new MarkerWithLabel({
            position: new google.maps.LatLng(<%= location[0][0] %>, <%= location[0][1] %>),
            map: map,
            labelContent: "<%= location[1] %>",
            labelClass: "tag-labels"
        });
      <% end %>

     <% else %>

       <% t_initial = Opinion.where(user_id: user_signed_in? ? current_user.id : cookies[:guest], question_id: question.id).order("created_at").last.tag_id %>

       <%  t_id = t_id
           opinion = Opinion.new
           loc_arr = opinion.user_lat_long_tag(question.id, t_id.nil? ? t_initial : t_id)
       %>

      var mapOptions = {
        zoom: 4,
        center: new google.maps.LatLng(user_lat, user_long)
      };

      var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

      <% loc_arr.each do |location| %>
        var marker = new MarkerWithLabel({
            position: new google.maps.LatLng(<%= location[0] %>, <%= location[1] %>),
            map: map,
            labelContent: "<%= Tag.where(id: t_id.nil? ? t_initial : t_id).first.label %>",
            labelClass: "tag-labels"
        });
      <% end %>

    <% end %>
  }

  google.maps.event.addDomListener(window, 'load', initialize);



  $(document).ready(function() {

    $(".slider").slider({max: 10, min: 1, step: 1}).slider("pips", {rest: "label", step: 1}).slider("float");

    $(".modal-button").click(function(){
      document.getElementById('numeric_value').value = $(".ui-slider-tip")[0].innerHTML;
    });

    $("form").bind("keypress", function (e) {
        if (e.keyCode == 13) {
            return false;
        }
    });

    var checkbox = $('.form-radio');

    <%if user_signed_in?
        @liked_tag = Opinion.where(user_id: current_user.id, question_id: @question.id)
        @liked_tag_array = Array.new()
        @liked_tag.each do |tagId|
          @liked_tag_array << Tag.where(question_id: @question.id, id: tagId.tag_id).first.label
        end
      else
        @liked_tag = Opinion.where(user_id: cookies[:guest], question_id: @question.id)
        @liked_tag_array = Array.new()
        @liked_tag.each do |tagId|
          @liked_tag_array << Tag.where(question_id: @question.id, id: tagId.tag_id).first.label
        end
      end
    %>

    $('input[type=radio]').not(':checked').parent().removeClass('checked'); //Remove checked class from all other radios that are not checked
    $('input[type=radio]').not(':checked').siblings().removeClass('checked').css("color", "#6a6a6a");

    <%if !@liked_tag_array.nil?%>
      <%@liked_tag_array.each do |tag|%>
        index = 0
        for(index; index <= <%= @tag_array.length - 1%>; index++){
          if ($('input[type=radio]')[index].value == "<%= tag %>"){
            $('input[type=radio]')[index].offsetParent.style.color = "white";
            var str_class = "checked" + "-tag_button_collection-" + String(index) + " tag_button_collection"
            $('input[type=radio]')[index].offsetParent.setAttribute("class", str_class);

            $('input[type=radio]')[index].nextElementSibling.src = "/images/blue_heart.png";
            $('input[type=radio]')[index].nextElementSibling.onmouseout = null
            $('input[type=radio]')[index].nextElementSibling.onmouseover = null
            $('input[type=radio]')[index].nextElementSibling.setAttribute("class", "blue-heart");
            $('input[type=radio]')[index].nextElementSibling.nextElementSibling.style.color = "white";
          }
        }
      <%end%>
    <%end%>


    $('input[type=radio]').on('change', function() {
      $(this).closest("form").submit();

    });

  });

</script>

<% if @answer == nil %>
<% @answer = user_signed_in? ? @question.answers.build(user_id: current_user.id) : @question.answers.build(user_id: cookies[:guest]) %>
<% end %>
<div class="tag-prompt">
  <%= simple_form_for @answer,:url => {:action => "add_tag", :controller => "answers"}, class: "form-inline", role: "form", html: {novalidate: true}, :remote => true do |f| %>
    <div id="otherInput">
      <div id="otherInputBox">
        <%= hidden_field_tag 'question_id', @question.id %>
        <%= f.label "New Tag", class: "new-tag" %>
        <%= f.input(:options_for_collection, label: false,input_html:{ value: nil, placeholder: "Add a tag or tags to concisely share your thoughts...", class: "other-input-text", id:"other"}) %>
        <%= f.submit "", class: "new-tag-submit" %>
      </div>
    </div>
    <br>
    <div class="options">

        <%if !@tag_array.nil?  %>
            <% counter = 0 %>

            <% @tag_array.each do |tag|%>
            <label class= "<%= "tag_button_collection-" + counter.to_s %> tag_button_collection ">
              <%= f.radio_button :value, tag.label, :class=>"form-radio"%>
              <%="#{tag.label}"%>
              <% @tag_count = tag.counter %>
              <%= image_tag("grey_heart.png", class:"grey-heart", :onMouseover=> "this.src='/images/blue_heart.png'",:onMouseout=> "this.src='/images/grey_heart.png'")%>
              <span class="tag-count">
                <%= @tag_count %>
              </span>
            </label>
            <% counter = counter + 1 %>
            <%end%>
      <% end %>
    </div>
  <% end %>

  <div id="map-canvas" style="height: 500px; width: 800px; margin: 0; padding-bottom: 50px;"></div>
  <div style="height: 30px;"><div>
</div>
